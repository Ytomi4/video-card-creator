<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Figma プラグイン: マスク画像取得</title>
    <style>
      :root {
        --figma-color-bg: #ffffff;
        --figma-color-bg-secondary: #f5f5f5;
        --figma-color-bg-tertiary: #e5e5e5;
        --figma-color-border: #e0e0e0;
        --figma-color-text: #333333;
        --figma-color-text-secondary: #666666;
        --figma-color-brand: #0d99ff;
        --figma-color-brand-hover: #0a8ae6;
        --figma-radius-small: 2px;
        --figma-radius-med: 6px;
        --figma-space-small: 8px;
        --figma-space-med: 16px;
        --figma-space-large: 24px;
        --figma-color-bg-disabled: rgba(0, 0, 0, 0.05);
        --figma-color-icon: #333333;
        --figma-color-icon-secondary: #666666;
        --figma-color-icon-disabled: rgba(0, 0, 0, 0.3);
      }
      body {
        font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        margin: 0;
        padding: var(--figma-space-med);
        background: var(--figma-color-bg);
        color: var(--figma-color-text);
        -webkit-font-smoothing: antialiased;
      }
      .section {
        margin-bottom: var(--figma-space-large);
      }
      .setup-steps {
        width: 100%;
        max-width: min(600px, 100vw - 2 * var(--figma-space-med));
        margin: var(--figma-space-med) auto;
        padding: 0 var(--figma-space-small);
        box-sizing: border-box;
      }
      .step {
        display: flex;
        align-items: flex-start;
        gap: var(--figma-space-med);
        margin-bottom: var(--figma-space-med);
        padding: var(--figma-space-med);
        border: 1px solid var(--figma-color-border);
        border-radius: var(--figma-radius-med);
        background: var(--figma-color-bg);
        transition: all 0.2s ease;
      }
      .step.completed {
        background: var(--figma-color-bg-secondary);
        border-color: var(--figma-color-brand);
      }
      .step.disabled {
        background: var(--figma-color-bg-tertiary);
        opacity: 0.6;
        pointer-events: none;
      }
      .step-number {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--figma-color-border);
        color: var(--figma-color-text-secondary);
        font-size: 14px;
        font-weight: 600;
        flex-shrink: 0;
        margin-top: 4px;
      }
      .step.completed .step-number {
        background: var(--figma-color-brand);
        color: white;
      }
      .step-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: var(--figma-space-small);
      }
      .step-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--figma-color-text);
        margin: 0;
      }
      .step-description {
        font-size: 12px;
        color: var(--figma-color-text-secondary);
        margin: 0;
      }
      .step-button {
        align-self: flex-start;
        min-width: 80px;
        width: auto;
      }
      .materials {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--figma-space-med);
        width: 100%;
        max-width: min(600px, 100vw - 2 * var(--figma-space-med));
        margin: var(--figma-space-med) auto;
        padding: 0 var(--figma-space-small);
        box-sizing: border-box;
      }
      .material-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: var(--figma-space-med);
        border: 1px solid var(--figma-color-border);
        border-radius: var(--figma-radius-med);
        background: var(--figma-color-bg);
        color: var(--figma-color-text);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        box-sizing: border-box;
        min-width: 0;
        font-family: inherit;
      }
      .material-button:hover:not(:disabled) {
        background: var(--figma-color-bg-secondary);
        border-color: var(--figma-color-text-secondary);
      }
      .material-button:disabled {
        background: var(--figma-color-bg-tertiary);
        color: var(--figma-color-text-secondary);
        border-color: var(--figma-color-border);
        cursor: not-allowed;
        opacity: 0.6;
      }
      /* プレビュー領域を初期状態で非表示にする */
      .preview-section {
        display: none;
      }

      .preview-section.visible {
        display: block;
      }

      .controls {
        margin-bottom: var(--figma-space-med);
        background: var(--figma-color-bg-secondary);
        padding: var(--figma-space-small);
        border-radius: var(--figma-radius-med);
      }
      .control-group {
        display: flex;
        align-items: center;
        gap: var(--figma-space-small);
      }
      .control-group label {
        color: var(--figma-color-text-secondary);
        font-size: 12px;
      }
      .control-group input[type="range"] {
        flex: 1;
        height: 2px;
        background: var(--figma-color-border);
        border-radius: var(--figma-radius-small);
      }
      .control-group span {
        font-size: 12px;
        color: var(--figma-color-text-secondary);
        min-width: 32px;
      }
      .canvas-container {
        position: relative;
      }
      #compositePreview {
        display: block;
        margin: 0 auto;
        border: 1px solid var(--figma-color-border);
        border-radius: var(--figma-radius-small);
        background: var(--figma-color-bg-tertiary);
      }
      .canvas-hint {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
      }
      .recording-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: var(--figma-space-large);
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .reset-controls {
        display: flex;
        justify-content: center;
        margin-top: var(--figma-space-med);
      }
      .primary-button {
        background: var(--figma-color-bg);
        color: #f24822;
        border: 2px solid #f24822;
        padding: var(--figma-space-small) var(--figma-space-med);
        border-radius: var(--figma-radius-med);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      .primary-button:hover {
        background: #fff5f2;
        border-color: #d9381e;
      }
      .primary-button:disabled {
        background: var(--figma-color-bg-tertiary);
        color: var(--figma-color-text-secondary);
        border-color: var(--figma-color-border);
        cursor: not-allowed;
      }
      .secondary-button {
        background: var(--figma-color-bg);
        color: var(--figma-color-text);
        border: 1px solid var(--figma-color-border);
        padding: var(--figma-space-small) var(--figma-space-med);
        border-radius: var(--figma-radius-med);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      .secondary-button:hover {
        background: var(--figma-color-bg-secondary);
        border-color: var(--figma-color-text-secondary);
      }
      .secondary-button:disabled {
        color: var(--figma-color-text-secondary);
        cursor: not-allowed;
      }
      .status-text {
        color: var(--figma-color-text-secondary);
        font-size: 12px;
      }
      .recording .status-text {
        color: #f44336;
      }
      .preview-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-top: 12px;
        flex-wrap: wrap;
      }
      .control-button {
        width: 44px;
        height: 44px;
        padding: 10px;
        border: 1px solid var(--figma-color-border);
        border-radius: var(--figma-radius-small);
        background: var(--figma-color-bg);
        color: var(--figma-color-icon);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .control-button:hover:not(:disabled) {
        background: var(--figma-color-bg-secondary);
        border-color: var(--figma-color-text-secondary);
      }
      .control-button:disabled {
        color: var(--figma-color-icon-disabled);
        background: var(--figma-color-bg-disabled);
        cursor: not-allowed;
      }
      .control-button.recording-button {
        border-color: #f24822;
        background: #fff5f2;
      }
      .control-button.recording-button:hover:not(:disabled) {
        background: #ffe8e1;
        border-color: #d9381e;
      }
      .control-button svg {
        width: 24px;
        height: 24px;
      }
      .status-text {
        font-size: 12px;
        color: var(--figma-color-text-secondary);
        margin-left: 12px;
      }
      .preview-button {
        width: 32px;
        height: 32px;
        padding: 4px;
        border: 1px solid var(--figma-color-border);
        border-radius: var(--figma-radius-small);
        background: transparent;
        color: var(--figma-color-icon);
        cursor: pointer;
        transition: all 0.1s ease;
      }
      .preview-button:hover:not(:disabled) {
        background: var(--figma-color-bg-secondary);
        border-color: var(--figma-color-text-secondary);
      }
      .preview-button:disabled {
        color: var(--figma-color-icon-disabled);
        background: var(--figma-color-bg-disabled);
        cursor: not-allowed;
      }
      .preview-button svg {
        width: 24px;
        height: 24px;
      }
    </style>
  </head>
  <body>
    <div class="section">
      <div class="setup-steps">
        <!-- ステップ1: フレーム選択 -->
        <div class="step" id="step1">
          <div class="step-number" id="step1Number">1</div>
          <div class="step-content">
            <h3 class="step-title">フレームを選ぶ</h3>
            <p class="step-description">
              Figma上でフレームを選択状態にして「次へ」をクリック
            </p>
            <button id="getMaskImage" class="material-button step-button">
              <span>次へ</span>
            </button>
          </div>
        </div>

        <!-- ステップ2: 動画選択 -->
        <div class="step disabled" id="step2">
          <div class="step-number" id="step2Number">2</div>
          <div class="step-content">
            <h3 class="step-title">動画を選ぶ</h3>
            <p class="step-description">
              背景に合成する動画ファイル（WebM/MP4）を選ぶ
            </p>
            <label
              class="material-button step-button"
              for="videoUpload"
              style="cursor: pointer"
              id="videoButton"
              disabled
            >
              <span>選ぶ</span>
            </label>
            <input
              type="file"
              id="videoUpload"
              accept="video/webm,video/mp4"
              hidden
            />
          </div>
        </div>
      </div>
    </div>

    <div class="section preview-section" id="previewSection">
      <div class="canvas-container">
        <canvas id="compositePreview"></canvas>
      </div>
      <div class="controls">
        <div class="control-group">
          <input
            type="range"
            id="scale"
            min="0.1"
            max="2"
            step="0.01"
            value="1"
          />
          <span id="scaleValue">1.00</span>
        </div>
      </div>
      <div class="preview-controls">
        <button
          id="resetVideo"
          class="control-button"
          disabled
          title="最初から"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"
              fill="currentColor"
            />
          </svg>
        </button>
        <button
          id="playVideo"
          class="control-button"
          disabled
          title="再生/一時停止"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M8 5v14l11-7z" fill="currentColor" />
          </svg>
        </button>
        <button
          id="muteVideo"
          class="control-button"
          disabled
          title="音量オン/オフ"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M3 10v4c0 .55.45 1 1 1h3l3.29 3.29c.63.63 1.71.18 1.71-.71V6.41c0-.89-1.08-1.34-1.71-.71L7 9H4c-.55 0-1 .45-1 1zm13.5 2A4.5 4.5 0 0014 7.97v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"
              fill="currentColor"
            />
          </svg>
        </button>
        <button
          id="startRecording"
          class="control-button recording-button"
          title="録画開始"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle cx="12" cy="12" r="8" fill="#F24822" />
          </svg>
        </button>
        <button
          id="stopRecording"
          class="control-button"
          disabled
          title="録画停止"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <rect x="6" y="6" width="12" height="12" rx="2" fill="#333" />
          </svg>
        </button>
        <div id="recordingStatus" class="status-text"></div>
      </div>
    </div>

    <div class="section preview-section" id="recordingSection">
      <div class="reset-controls">
        <button
          id="resetAll"
          class="secondary-button"
          title="フレームと動画の選択をリセット"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M3 12c0 4.97 4.03 9 9 9s9-4.03 9-9-4.03-9-9-9c-1.31 0-2.56.28-3.68.78l1.5 1.5C10.18 4.78 11.07 4.5 12 4.5c4.14 0 7.5 3.36 7.5 7.5s-3.36 7.5-7.5 7.5S4.5 16.14 4.5 12H6l-3-3-3 3h1.5z"
              fill="currentColor"
            />
          </svg>
          リセット
        </button>
      </div>
    </div>

    <script>
      // マスク画像取得
      document.getElementById("getMaskImage").onclick = () => {
        parent.postMessage({ pluginMessage: { type: "get-mask-image" } }, "*");
      };
      // Figmaからのメッセージ処理
      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;
        if (msg.type === "mask-image") {
          const blob = new Blob([new Uint8Array(msg.data)], {
            type: "image/png",
          });
          const url = URL.createObjectURL(blob);
          const img = new Image();
          img.onload = () => {
            maskImage = img;
            updateMaskStatus(true);
            updateCanvasSize();
            // ステップ1を完了状態にする
            updateStepStatus(1, true);
            // フレームが選択されたらプレビュー領域を表示
            showPreviewSection();
          };
          img.src = url;
        } else if (msg.type === "error") {
          alert(msg.message);
        }
      };

      // 合成プレビューの状態管理
      let maskImage = null;
      let videoElement = null;
      const canvas = document.getElementById("compositePreview");
      const ctx = canvas.getContext("2d");
      let posX = 0;
      let posY = 0;
      let scale = 1;

      // ステップの状態管理
      function updateStepStatus(stepNumber, completed) {
        const step = document.getElementById(`step${stepNumber}`);
        const stepNumberEl = document.getElementById(`step${stepNumber}Number`);

        if (completed) {
          step.classList.add("completed");
          step.classList.remove("disabled");
          // チェックマークを表示
          stepNumberEl.innerHTML = "✓";

          // 次のステップを有効化
          if (stepNumber === 1) {
            const step2 = document.getElementById("step2");
            const videoButton = document.getElementById("videoButton");
            step2.classList.remove("disabled");
            videoButton.removeAttribute("disabled");
          }
        }
      }

      // プレビュー領域を表示する関数
      function showPreviewSection() {
        document.getElementById("previewSection").classList.add("visible");
        document.getElementById("recordingSection").classList.add("visible");
      }

      // キャンバスサイズの設定
      function updateCanvasSize() {
        if (maskImage) {
          canvas.width = maskImage.width;
          canvas.height = maskImage.height;
        } else if (
          videoElement &&
          videoElement.videoWidth &&
          videoElement.videoHeight
        ) {
          canvas.width = videoElement.videoWidth;
          canvas.height = videoElement.videoHeight;
        }
        drawComposite();
      }

      // 合成描画
      function drawComposite() {
        // キャンバスが初期化されていない場合は初期化
        if (!canvas.width || !canvas.height) {
          if (maskImage) {
            canvas.width = maskImage.width;
            canvas.height = maskImage.height;
          } else if (videoElement) {
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
          } else {
            return; // どちらの素材もない場合は何もしない
          }
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 下層に動画を描画（もしあれば）
        if (videoElement && videoElement.readyState >= 2) {
          // HAVE_CURRENT_DATA以上
          ctx.save();
          ctx.translate(posX, posY);
          ctx.scale(scale, scale);
          ctx.drawImage(videoElement, 0, 0);
          ctx.restore();
        }

        // 上層にマスク画像を描画（もしあれば）
        if (maskImage) {
          ctx.drawImage(maskImage, 0, 0);
        }
      }

      // プレビューコントロールの更新
      function updatePreviewControls() {
        const playButton = document.getElementById("playVideo");
        const resetButton = document.getElementById("resetVideo");
        const muteButton = document.getElementById("muteVideo");
        const hasVideo = videoElement != null;

        playButton.disabled = !hasVideo;
        resetButton.disabled = !hasVideo;
        muteButton.disabled = !hasVideo;

        // 再生/一時停止アイコンの更新
        if (hasVideo && !videoElement.paused) {
          playButton.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" fill="currentColor"/>
            </svg>
          `;
          playButton.title = "一時停止";
        } else {
          playButton.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 5v14l11-7z" fill="currentColor"/>
            </svg>
          `;
          playButton.title = "再生";
        }

        // 音量ボタンの更新
        if (hasVideo) {
          updateMuteButton();
        }
      }

      // 動画ファイルアップロード処理
      document.getElementById("videoUpload").onchange = (event) => {
        // ステップ1が完了していない場合は処理しない
        const videoButton = document.getElementById("videoButton");
        if (videoButton.hasAttribute("disabled")) {
          return;
        }

        const file = event.target.files[0];
        if (!file) {
          updateVideoStatus(false);
          videoElement = null;
          updatePreviewControls();
          return;
        }

        // 動画ファイルの形式チェック
        if (!file.type.match(/^video\/(webm|mp4)$/)) {
          alert("WebMまたはMP4形式の動画ファイルを選択してください。");
          updateVideoStatus(false);
          updatePreviewControls();
          return;
        }

        const url = URL.createObjectURL(file);
        const video = document.createElement("video");
        video.src = url;

        // 必要な属性を設定
        video.autoplay = false;
        video.loop = true;
        video.muted = false; // 音声を有効にする

        // 合成プレビュー用の参照を保存
        videoElement = video;

        // メタデータ読み込み完了時の処理
        video.onloadeddata = async () => {
          updateVideoStatus(true);
          updatePreviewControls();
          // ステップ2を完了状態にする
          updateStepStatus(2, true);

          // キャンバスサイズを更新（マスクがある場合はマスクに、ない場合は動画に合わせる）
          updateCanvasSize();

          // 最初のフレームを表示するために一時的に再生
          try {
            await video.play();
            video.pause();
            // 少し待ってから描画（フレームデータが確実に利用可能になるまで）
            setTimeout(() => {
              drawComposite();
            }, 100);
          } catch (error) {
            console.log("Video play error:", error);
            // エラーが発生しても描画は試行
            drawComposite();
          }
        };

        // フレームデータが利用可能になったときの処理
        video.addEventListener("loadedmetadata", () => {
          updateCanvasSize();
        });

        video.addEventListener("canplay", () => {
          drawComposite();
        });

        // 再生状態変更時の処理
        video.addEventListener("play", () => {
          updatePreviewControls();
        });

        video.addEventListener("pause", () => {
          updatePreviewControls();
        });

        // 再生時の更新処理
        video.addEventListener("play", () => {
          function updateCanvas() {
            if (!video.paused && !video.ended) {
              drawComposite();
              requestAnimationFrame(updateCanvas);
            }
          }
          updateCanvas();
        });
      };

      // 状態表示の更新関数
      function updateMaskStatus(selected) {
        // ステータス表示要素が削除されたため、何もしない
        // 必要に応じて他の視覚的フィードバックを追加可能
      }

      function updateVideoStatus(selected) {
        // ステータス表示要素が削除されたため、何もしない
        // 必要に応じて他の視覚的フィードバックを追加可能
      }

      // ドラッグ＆ドロップの制御
      let isDragging = false;
      let dragStartX = 0;
      let dragStartY = 0;
      let startPosX = 0;
      let startPosY = 0;

      canvas.addEventListener("mousedown", (e) => {
        if (!maskImage || !videoElement) return;
        isDragging = true;
        const rect = canvas.getBoundingClientRect();
        dragStartX = e.clientX - rect.left;
        dragStartY = e.clientY - rect.top;
        startPosX = posX;
        startPosY = posY;
        canvas.style.cursor = "grabbing";
      });

      document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        posX = startPosX + (x - dragStartX);
        posY = startPosY + (y - dragStartY);

        drawComposite();
      });

      document.addEventListener("mouseup", () => {
        isDragging = false;
        canvas.style.cursor = "move";
      });

      // スケール制御
      document.getElementById("scale").oninput = (e) => {
        scale = parseFloat(e.target.value);
        document.getElementById("scaleValue").textContent = scale.toFixed(2);
        drawComposite();
      };

      // プレビュー用の動画コントロール
      document.getElementById("playVideo").onclick = async () => {
        if (!videoElement) return;

        if (videoElement.paused) {
          await videoElement.play();
        } else {
          videoElement.pause();
        }
        updatePreviewControls();
      };

      document.getElementById("resetVideo").onclick = () => {
        if (!videoElement) return;

        videoElement.currentTime = 0;
        drawComposite();
      };

      // 音量制御
      document.getElementById("muteVideo").onclick = () => {
        if (!videoElement) return;

        videoElement.muted = !videoElement.muted;
        updateMuteButton();
      };

      // 音量ボタンの表示更新
      function updateMuteButton() {
        const muteButton = document.getElementById("muteVideo");
        const isMuted = videoElement ? videoElement.muted : true;

        if (isMuted) {
          muteButton.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z" fill="currentColor"/>
            </svg>
          `;
          muteButton.title = "音量オン";
        } else {
          muteButton.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 10v4c0 .55.45 1 1 1h3l3.29 3.29c.63.63 1.71.18 1.71-.71V6.41c0-.89-1.08-1.34-1.71-.71L7 9H4c-.55 0-1 .45-1 1zm13.5 2A4.5 4.5 0 0014 7.97v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" fill="currentColor"/>
            </svg>
          `;
          muteButton.title = "音量オフ";
        }
      }

      // 録画制御
      let mediaRecorder = null;
      let recordedChunks = [];
      let isRecording = false;

      document.getElementById("startRecording").onclick = async () => {
        if (!videoElement || !maskImage) {
          alert("マスク画像と動画を両方セットしてください。");
          return;
        }

        // キャンバスと音声を組み合わせたストリームを作成
        const canvasStream = canvas.captureStream();
        const audioTrack = videoElement.captureStream().getAudioTracks()[0];
        if (audioTrack) {
          canvasStream.addTrack(audioTrack);
        }

        // 録画の準備
        mediaRecorder = new MediaRecorder(canvasStream, {
          mimeType: "video/webm",
        });
        recordedChunks = [];

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            recordedChunks.push(e.data);
          }
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "recorded-video.webm";
          a.click();
          URL.revokeObjectURL(url);

          // UI状態を更新
          isRecording = false;
          document.getElementById("startRecording").disabled = false;
          document.getElementById("stopRecording").disabled = true;
          document.getElementById("recordingStatus").textContent = "録画完了";
          document.body.classList.remove("recording");
        };

        // 録画開始前の準備
        videoElement.loop = false; // 録画時はループを無効化
        videoElement.currentTime = 0;

        // 動画終了時の処理を設定
        const handleVideoEnd = () => {
          if (isRecording) {
            mediaRecorder.stop();
            videoElement.removeEventListener("ended", handleVideoEnd);
            videoElement.loop = true; // プレビュー用のループを再有効化
          }
        };
        videoElement.addEventListener("ended", handleVideoEnd);

        // 録画開始
        await videoElement.play();
        mediaRecorder.start();
        isRecording = true;

        // UI状態を更新
        document.getElementById("startRecording").disabled = true;
        document.getElementById("stopRecording").disabled = false;
        document.getElementById("recordingStatus").textContent = "録画中...";
        document.body.classList.add("recording");
      };

      // 手動停止
      document.getElementById("stopRecording").onclick = () => {
        if (isRecording && mediaRecorder) {
          mediaRecorder.stop();
          videoElement.pause();
        }
      };

      // リセット機能
      document.getElementById("resetAll").onclick = () => {
        // 確認ダイアログ
        if (!confirm("フレームと動画の選択をリセットしますか？")) {
          return;
        }

        // 録画中の場合は停止
        if (isRecording && mediaRecorder) {
          mediaRecorder.stop();
          videoElement.pause();
        }

        // 状態をリセット
        maskImage = null;
        videoElement = null;
        posX = 0;
        posY = 0;
        scale = 1;

        // UI要素をリセット
        document.getElementById("scaleValue").textContent = "1.00";
        document.getElementById("scale").value = "1";
        document.getElementById("videoUpload").value = "";
        document.getElementById("recordingStatus").textContent = "";

        // ステップ状態をリセット
        const step1 = document.getElementById("step1");
        const step2 = document.getElementById("step2");
        const step1Number = document.getElementById("step1Number");
        const step2Number = document.getElementById("step2Number");
        const videoButton = document.getElementById("videoButton");

        step1.classList.remove("completed");
        step2.classList.remove("completed");
        step2.classList.add("disabled");
        step1Number.innerHTML = "1";
        step2Number.innerHTML = "2";
        videoButton.setAttribute("disabled", "");

        // プレビュー領域を非表示
        document.getElementById("previewSection").classList.remove("visible");
        document.getElementById("recordingSection").classList.remove("visible");

        // キャンバスをクリア
        const canvas = document.getElementById("compositePreview");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        canvas.width = 0;
        canvas.height = 0;

        // ボタンの状態をリセット
        document.getElementById("startRecording").disabled = false;
        document.getElementById("stopRecording").disabled = true;
        document.getElementById("playVideo").disabled = true;
        document.getElementById("resetVideo").disabled = true;
        document.getElementById("muteVideo").disabled = true;

        // 録画状態をリセット
        isRecording = false;
        document.body.classList.remove("recording");
      };
    </script>
  </body>
</html>
